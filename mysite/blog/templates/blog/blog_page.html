{% extends "base.html" %}
{% load static wagtailcore_tags wagtailimages_tags %}

{% block content %}

<div class="blog-container">

   

    <h1>{{ page.title }}</h1>

    <!-- STATS -->
    <p class="stats">
         {{ page.views }} views  
         <span id="likes-count">{{ page.likes }}</span> likes  
         {{ page.comments_count }} comments
    </p>

    <hr>

    <!-- BODY -->
    <div class="body-text">
        {{ page.body|richtext }}
    </div>

    <hr>

    <!-- LIKE BUTTON -->
    <button id="likeBtn" class="like-btn">
         Like
    </button>

    <hr>

<!-- COMMENTS + SIDE IMAGE WRAPPER -->
<div class="comments-wrapper">

    <!-- COMMENTS SECTION -->
    <div class="comments-left">
        <h3>Comments ({{ page.comments_count }})</h3>

        <div id="comments-container">
            {% if page.pk %}
                {% for c in page.comments.all %}
                    <div class="comment-box">
                        <p>{{ c.text }}</p>
                        <small>{{ c.created_at }}</small>
                    </div>
                {% empty %}
                    <p>No comments yet.</p>
                {% endfor %}
            {% else %}
                <p>Comments will appear after the page is published.</p>
            {% endif %}
        </div>

        <!-- COMMENT FORM -->
        <form id="commentForm" class="comment-form">
            {% csrf_token %}
            <textarea name="comment" required placeholder="Write a comment..."></textarea>
            <button type="submit">Post Comment</button>
        </form>
    </div>

    <!-- RIGHT SIDE IMAGE -->
    <div class="comments-image">
        {% if page.cover_image %}
            {% image page.cover_image original as img %}
            <img src="{{ img.url }}" alt="{{ page.title }}">
        {% endif %}
    </div>

</div>

</div>


<!-- ============================= -->
<!--  JAVASCRIPT SECTION           -->
<!-- ============================= -->

<script>
// ------------------------------
// LIKE BUTTON
// ------------------------------
document.getElementById("likeBtn").onclick = async () => {
    let response = await fetch("/blog/like/{{ page.id }}/", {
        method: "POST",
        headers: {
            "X-CSRFToken": "{{ csrf_token }}",
        },
    });

    let data = await response.json();
    if (data.success) {
        document.getElementById("likes-count").innerText = data.likes;
    }
};


// ------------------------------
// COMMENT FORM
// ------------------------------
document.getElementById("commentForm").onsubmit = async (e) => {
    e.preventDefault();

    let formData = new FormData(e.target);

    let response = await fetch("/blog/comment/{{ page.id }}/", {
        method: "POST",
        headers: {
            "X-CSRFToken": "{{ csrf_token }}",
        },
        body: formData
    });

    let data = await response.json();

    if (data.success) {
        location.reload();  // Reload to show new comment
    } else {
        alert(data.error || "Something went wrong");
    }
};
</script>


<!-- Optional CSS for style -->
<style>
.blog-container { max-width: 700px; margin: auto; padding: 20px; }
.cover-img img { width: 100%; border-radius: 8px; }
.stats { color: gray; margin-bottom: 10px; }
.comment-box { padding: 10px; margin-bottom: 10px; background: #f9f9f9; border-radius: 5px; }
.comment-form textarea { width: 100%; height: 70px; margin-bottom: 10px; }
.like-btn { padding: 8px 15px; background: red; color: white; border-radius: 5px; border: none; cursor: pointer; }

.cover-img img {
    max-width: 400px;   /* adjust size here */
    width: 100%;
    height: auto;
    display: block;
    margin: 0 auto;      /* center the image */
    border-radius: 10px;
}
.comments-wrapper {
    display: flex;
    gap: 20px;
    margin-top: 20px;
}

/* Left: comments take more space */
.comments-left {
    flex: 2;
}

/* Right: image column */
.comments-image {
    flex: 1;
    display: flex;
    justify-content: center;
    align-items: start;
}

.comments-image img {
    width: 100%;
    max-width: 250px;   /* control image size */
    border-radius: 10px;
    object-fit: cover;
}


</style>

{% endblock %}
